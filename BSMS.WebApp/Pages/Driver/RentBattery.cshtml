@page
@using BSMS.BusinessObjects.Enums
@model BSMS.WebApp.Pages.Driver.RentBatteryModel
@{
    ViewData["Title"] = "Gói thuê pin";
}

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i>
        @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<h2 class="mb-4 fw-bold">
    <i class="bi bi-battery-charging me-2 text-primary"></i> @ViewData["Title"]
</h2>

<div class="row g-4">

    @foreach (var pkg in Model.Packages)
    {
        var userPkg = Model.PurchasedPackages
        .FirstOrDefault(p => p.PackageId == pkg.PackageId);

        bool isPurchasedActive = userPkg != null
        && userPkg.Status == PackageStatus.Active
        && userPkg.EndDate >= DateTime.Today;

        bool isExpired = userPkg != null
        && userPkg.Status == PackageStatus.Expired;

        <div class="col-md-4">
            <div class="card package-card h-100 shadow-sm border-0 @(isPurchasedActive ? "active-package" : "")">
                <div class="card-body text-center p-4 position-relative">

                    <!-- BADGES -->
                    @if (isPurchasedActive)
                    {
                        <span class="badge bg-success position-absolute top-0 end-0 m-3 px-3 py-2">
                            <i class="bi bi-check2-circle me-1"></i> Đang dùng
                        </span>
                    }
                    else if (isExpired)
                    {
                        <span class="badge bg-danger position-absolute top-0 end-0 m-3 px-3 py-2">
                            <i class="bi bi-x-circle me-1"></i> Đã hết hạn
                        </span>
                    }

                    <div class="icon-wrapper mb-3">
                        <i class="bi bi-battery-half text-primary"></i>
                    </div>

                    <h4 class="fw-bold">@pkg.Name</h4>
                    <h3 class="text-danger fw-bolder mb-2">@String.Format("{0:N0}", pkg.Price) đ</h3>

                    <p class="text-muted small mb-3">
                        <i class="bi bi-clock me-1"></i>
                        Thời hạn: <span class="fw-semibold">@pkg.DurationDays ngày</span>
                    </p>

                    <!-- BUTTON LOGIC -->
                    @if (isPurchasedActive)
                    {
                        <button class="btn btn-secondary w-100 py-2 fw-semibold" disabled>
                            <i class="bi bi-check2-circle me-1"></i> Đã mua
                        </button>
                    }
                    else if (isExpired)
                    {
                        <!-- Hết hạn → Hiện Gia hạn -->
                        <form method="post" asp-page-handler="Renew">
                            <input type="hidden" name="packageId" value="@pkg.PackageId" />
                            <button type="submit" class="btn btn-warning w-100 py-2 fw-semibold">
                                <i class="bi bi-arrow-repeat me-1"></i> Gia hạn gói
                            </button>
                        </form>
                    }
                    else
                    {
                        <!-- Chưa mua → Hiện Mua ngay -->
                        <form method="post" asp-page-handler="Buy">
                            <input type="hidden" name="packageId" value="@pkg.PackageId" />
                            <button type="submit" class="btn btn-success w-100 py-2 fw-semibold">
                                <i class="bi bi-cart-plus me-1"></i> Mua ngay
                            </button>
                        </form>
                    }
                </div>
            </div>
        </div>
    }

</div>

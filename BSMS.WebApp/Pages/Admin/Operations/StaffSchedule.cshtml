@page
@model BSMS.WebApp.Pages.Admin.Operations.StaffScheduleModel
@{
    ViewData["Title"] = "Quản lý lịch làm việc nhân viên";
}

<div class="container-fluid py-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="fw-bold mb-0">
            <i class="bi bi-calendar-check me-2"></i>Quản lý lịch làm việc nhân viên
        </h2>
        
        <!-- ✅ NÚT TẠO NHÂN VIÊN MỚI -->
        <div class="d-flex gap-2 align-items-center">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createStaffModal">
                <i class="bi bi-person-plus-fill me-2"></i>Tạo nhân viên mới
            </button>
            
            <span class="badge bg-success fs-6">
                <i class="bi bi-person-check me-1"></i>
                @Model.CurrentlyWorkingStaff.Count Nhân viên đang làm việc
            </span>
            @if (Model.TotalEmptyShifts > 0)
            {
                <span class="badge bg-danger fs-6">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    @Model.TotalEmptyShifts Ca trống
                </span>
            }
        </div>
    </div>

    @if (!string.IsNullOrEmpty(Model.SuccessMessage))
    {
        <div class="alert alert-success alert-dismissible fade show">
            <i class="bi bi-check-circle me-2"></i>@Model.SuccessMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show">
            <i class="bi bi-exclamation-triangle me-2"></i>@Model.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- ✅ Shift Coverage Dashboard -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white border-0">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history me-2"></i>Phân ca theo trạm
                </h5>
                <small class="text-muted">Sáng: 6:00-14:00 | Chiều: 14:00-22:00</small>
            </div>
        </div>
        <div class="card-body">
            <div class="row g-3">
                @foreach (var coverage in Model.ShiftCoverageByStation)
                {
                    <div class="col-md-6 col-lg-4">
                        <div class="card h-100 @(coverage.IsFullyCovered ? "border-success" : coverage.HasAnyCoverage ? "border-warning" : "border-danger")">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <h6 class="fw-bold mb-1">@coverage.StationName</h6>
                                        <small class="text-muted">@coverage.StationAddress</small>
                                    </div>
                                    @if (coverage.IsFullyCovered)
                                    {
                                        <i class="bi bi-check-circle-fill text-success fs-4"></i>
                                    }
                                    else if (coverage.EmptyShiftCount == 2)
                                    {
                                        <i class="bi bi-exclamation-triangle-fill text-danger fs-4"></i>
                                    }
                                    else
                                    {
                                        <i class="bi bi-exclamation-circle-fill text-warning fs-4"></i>
                                    }
                                </div>

                                <!-- Morning Shift -->
                                <div class="mb-2">
                                    <div class="d-flex align-items-center mb-1">
                                        <i class="bi bi-sunrise me-2 text-warning"></i>
                                        <strong class="small">Ca sáng</strong>
                                    </div>
                                    @if (coverage.HasMorningCoverage)
                                    {
                                        <div class="ms-4">
                                            @foreach (var staff in coverage.MorningShiftStaff)
                                            {
                                                <div class="d-flex align-items-center gap-2 mb-1">
                                                    <span class="badge bg-success text-white">
                                                        @staff.User?.FullName
                                                    </span>
                                                    <small class="text-muted">
                                                        @staff.ShiftStart.ToString(@"hh\:mm")-@staff.ShiftEnd.ToString(@"hh\:mm")
                                                    </small>
                                                    @if (staff.IsCurrentlyWorking)
                                                    {
                                                        <span class="badge bg-success text-white">
                                                            <i class="bi bi-circle-fill" style="font-size: 0.5rem;"></i> Đang làm
                                                        </span>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="ms-4">
                                            <span class="badge bg-danger text-white">
                                                <i class="bi bi-exclamation-triangle me-1"></i>Chưa có nhân viên
                                            </span>
                                        </div>
                                    }
                                </div>

                                <!-- Afternoon Shift -->
                                <div>
                                    <div class="d-flex align-items-center mb-1">
                                        <i class="bi bi-sunset me-2 text-info"></i>
                                        <strong class="small">Ca chiều</strong>
                                    </div>
                                    @if (coverage.HasAfternoonCoverage)
                                    {
                                        <div class="ms-4">
                                            @foreach (var staff in coverage.AfternoonShiftStaff)
                                            {
                                                <div class="d-flex align-items-center gap-2 mb-1">
                                                    <span class="badge bg-info text-white">
                                                        @staff.User?.FullName
                                                    </span>
                                                    <small class="text-muted">
                                                        @staff.ShiftStart.ToString(@"hh\:mm")-@staff.ShiftEnd.ToString(@"hh\:mm")
                                                    </small>
                                                    @if (staff.IsCurrentlyWorking)
                                                    {
                                                        <span class="badge bg-success text-white">
                                                            <i class="bi bi-circle-fill" style="font-size: 0.5rem;"></i> Đang làm
                                                        </span>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="ms-4">
                                            <span class="badge bg-danger text-white">
                                                <i class="bi bi-exclamation-triangle me-1"></i>Chưa có nhân viên
                                            </span>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

            @if (!Model.ShiftCoverageByStation.Any())
            {
                <div class="text-center text-muted py-4">
                    <i class="bi bi-inbox fs-1"></i>
                    <p class="mt-2">Không tìm thấy trạm nào</p>
                </div>
            }
        </div>
    </div>

    <!-- Assign/Edit Staff Form -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white border-0">
            <h5 class="mb-0">
                @(Model.IsEditMode ? "Chỉnh sửa phân ca" : "Phân công nhân viên vào trạm")
            </h5>
        </div>
        <div class="card-body">
            <form method="post" asp-page-handler="AssignStaff" id="staffAssignmentForm" autocomplete="off">
                <input type="hidden" asp-for="Input.StaffId" />
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label asp-for="Input.UserId" class="form-label">
                            Nhân viên <span class="text-danger">*</span>
                        </label>
                        <select asp-for="Input.UserId" class="form-select" required id="staffSelect">
                            <option value="">-- Chọn nhân viên --</option>
                            @foreach (var staff in Model.AvailableStaff)
                            {
                                var isWorking = Model.CurrentlyWorkingStaff.Any(s => s.UserId == staff.UserId);
                                var workingText = isWorking ? " ✓ Đang làm việc" : "";
                                <option value="@staff.UserId">@staff.FullName (@staff.Username)@workingText</option>
                            }
                        </select>
                        <span asp-validation-for="Input.UserId" class="text-danger small"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="Input.StationId" class="form-label">
                            Trạm <span class="text-danger">*</span>
                        </label>
                        <select asp-for="Input.StationId" class="form-select" required>
                            <option value="">-- Chọn trạm --</option>
                            @foreach (var station in Model.Stations)
                            {
                                <option value="@station.StationId">@station.Name - @station.Address</option>
                            }
                        </select>
                        <span asp-validation-for="Input.StationId" class="text-danger small"></span>
                    </div>

                    <div class="col-md-4">
                        <label asp-for="Input.ShiftStart" class="form-label">
                            Giờ bắt đầu ca <span class="text-danger">*</span>
                        </label>
                        <input type="time" 
                               asp-for="Input.ShiftStart" 
                               class="form-control" 
                               min="06:00" 
                               max="22:00"
                               required
                               data-val="true"
                               data-val-timerange="Ca làm việc phải trong khoảng 6:00 sáng đến 10:00 tối"
                               data-val-timerange-min="06:00"
                               data-val-timerange-max="22:00" />
                        <small class="text-muted">Từ 6:00 sáng - 10:00 tối</small>
                        <span asp-validation-for="Input.ShiftStart" class="text-danger small"></span>
                    </div>

                    <div class="col-md-4">
                        <label asp-for="Input.ShiftEnd" class="form-label">
                            Giờ kết thúc ca <span class="text-danger">*</span>
                        </label>
                        <input type="time" 
                               asp-for="Input.ShiftEnd" 
                               class="form-control" 
                               min="06:00" 
                               max="22:00"
                               required
                               data-val="true"
                               data-val-timerange="Ca làm việc phải trong khoảng 6:00 sáng đến 10:00 tối"
                               data-val-timerange-min="06:00"
                               data-val-timerange-max="22:00" />
                        <small class="text-muted">Từ 6:00 sáng - 10:00 tối</small>
                        <span asp-validation-for="Input.ShiftEnd" class="text-danger small"></span>
                    </div>

                    <div class="col-md-4">
                        <label asp-for="Input.AssignedAt" class="form-label">
                            Ngày phân công
                        </label>
                        <div class="input-group">
                            <input type="datetime-local" 
                                   asp-for="Input.AssignedAt" 
                                   class="form-control" 
                                   id="assignedAtInput"
                                   disabled />
                            <button type="button" class="btn btn-outline-secondary" id="toggleManualDate" title="Cho phép chỉnh sửa">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </div>
                        <small class="text-muted">Tự động điền ngày/giờ hiện tại</small>
                        <span asp-validation-for="Input.AssignedAt" class="text-danger small"></span>
                    </div>

                    <div class="col-md-12">
                        <div class="form-check">
                            <input type="checkbox" asp-for="Input.IsActive" class="form-check-input" id="isActiveCheck" />
                            <label class="form-check-label" for="isActiveCheck">
                                Phân ca hoạt động
                            </label>
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle me-2"></i>@(Model.IsEditMode ? "Cập nhật phân ca" : "Phân công nhân viên")
                    </button>
                    @if (Model.IsEditMode)
                    {
                        <a asp-page="/Admin/Operations/StaffSchedule" class="btn btn-secondary">
                            <i class="bi bi-x-circle me-2"></i>Hủy chỉnh sửa
                        </a>
                    }
                </div>
            </form>
        </div>
    </div>

    <!-- Current Assignments Table -->
    <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-0">
            <h5 class="mb-0">Tất cả phân ca nhân viên</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Tên nhân viên</th>
                            <th>Trạm</th>
                            <th>Ca làm</th>
                            <th>Thời lượng</th>
                            <th>Ngày phân</th>
                            <th>Trạng thái</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var assignment in Model.Assignments)
                        {
                            <tr class="@(assignment.IsCurrentlyWorking ? "table-success" : "")">
                                <td>@assignment.StaffId</td>
                                <td>
                                    <strong>@assignment.User?.FullName</strong>
                                    <div class="small text-muted">@assignment.User?.Username</div>
                                </td>
                                <td>@assignment.Station?.Name</td>
                                <td>
                                    <span class="badge bg-info">
                                        @assignment.ShiftStart.ToString(@"hh\:mm") - @assignment.ShiftEnd.ToString(@"hh\:mm")
                                    </span>
                                </td>
                                <td>@assignment.ShiftDuration.TotalHours.ToString("0.0")h</td>
                                <td>@assignment.AssignedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</td>
                                <td>
                                    @if (assignment.IsActive)
                                    {
                                        <span class="badge bg-success">Hoạt động</span>
                                        @if (assignment.IsCurrentlyWorking)
                                        {
                                            <span class="badge bg-warning text-dark ms-1">
                                                <i class="bi bi-circle-fill" style="font-size: 0.5rem; animation: pulse 2s infinite;"></i>
                                                Đang làm
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary ms-1">Ngoài ca</span>
                                        }
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">Không hoạt động</span>
                                    }
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a asp-page="/Admin/Operations/StaffSchedule" 
                                           asp-route-staffId="@assignment.StaffId" 
                                           class="btn btn-outline-primary">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <form method="post" asp-page-handler="RemoveAssignment" class="d-inline">
                                            <input type="hidden" name="staffId" value="@assignment.StaffId" />
                                            <button type="submit" 
                                                    class="btn btn-outline-danger"
                                                    onclick="return confirm('Xóa phân ca này?');">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- ✅ MODAL TẠO NHÂN VIÊN MỚI -->
<div class="modal fade" id="createStaffModal" tabindex="-1" aria-labelledby="createStaffModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" asp-page-handler="CreateNewStaff" id="createStaffForm" autocomplete="off">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="createStaffModalLabel">
                        <i class="bi bi-person-plus-fill me-2"></i>Tạo nhân viên mới
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Lưu ý:</strong> Nhân viên mới sẽ được tạo với vai trò <strong>StationStaff</strong> 
                        và có thể đăng nhập ngay sau khi tạo.
                    </div>

                    <div class="row g-3">
                        <!-- Họ tên -->
                        <div class="col-md-6">
                            <label asp-for="NewStaffInput.FullName" class="form-label">
                                Họ và tên <span class="text-danger">*</span>
                            </label>
                            <input type="text" 
                                   asp-for="NewStaffInput.FullName" 
                                   class="form-control" 
                                   placeholder="VD: Nguyễn Văn A"
                                   required
                                   maxlength="100" />
                            <span asp-validation-for="NewStaffInput.FullName" class="text-danger small"></span>
                        </div>

                        <!-- Username -->
                        <div class="col-md-6">
                            <label asp-for="NewStaffInput.Username" class="form-label">
                                Tên đăng nhập <span class="text-danger">*</span>
                            </label>
                            <input type="text" 
                                   asp-for="NewStaffInput.Username" 
                                   class="form-control" 
                                   placeholder="VD: staff5"
                                   required
                                   minlength="4"
                                   maxlength="50"
                                   pattern="[a-zA-Z0-9_]+"
                                   title="Chỉ chứa chữ cái, số và dấu gạch dưới" />
                            <span asp-validation-for="NewStaffInput.Username" class="text-danger small"></span>
                        </div>

                        <!-- Email -->
                        <div class="col-md-6">
                            <label asp-for="NewStaffInput.Email" class="form-label">
                                Email <span class="text-danger">*</span>
                            </label>
                            <input type="email" 
                                   asp-for="NewStaffInput.Email" 
                                   class="form-control" 
                                   placeholder="example@email.com"
                                   required />
                            <span asp-validation-for="NewStaffInput.Email" class="text-danger small"></span>
                        </div>

                        <!-- Phone -->
                        <div class="col-md-6">
                            <label asp-for="NewStaffInput.Phone" class="form-label">
                                Số điện thoại
                            </label>
                            <input type="tel" 
                                   asp-for="NewStaffInput.Phone" 
                                   class="form-control" 
                                   placeholder="0901234567"
                                   pattern="[0-9]{10,11}"
                                   title="Nhập 10-11 số" />
                            <span asp-validation-for="NewStaffInput.Phone" class="text-danger small"></span>
                        </div>

                        <!-- Password -->
                        <div class="col-md-6">
                            <label asp-for="NewStaffInput.Password" class="form-label">
                                Mật khẩu <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <input type="password" 
                                       asp-for="NewStaffInput.Password" 
                                       class="form-control" 
                                       id="passwordInput"
                                       placeholder="Tối thiểu 6 ký tự"
                                       required
                                       minlength="6"
                                       maxlength="100" />
                                <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <span asp-validation-for="NewStaffInput.Password" class="text-danger small"></span>
                        </div>

                        <!-- Confirm Password -->
                        <div class="col-md-6">
                            <label asp-for="NewStaffInput.ConfirmPassword" class="form-label">
                                Xác nhận mật khẩu <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <input type="password" 
                                       asp-for="NewStaffInput.ConfirmPassword" 
                                       class="form-control" 
                                       id="confirmPasswordInput"
                                       placeholder="Nhập lại mật khẩu"
                                       required
                                       minlength="6"
                                       maxlength="100" />
                                <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <span asp-validation-for="NewStaffInput.ConfirmPassword" class="text-danger small"></span>
                        </div>

                        <!-- ❌ XÓA CHECKBOX "PHÂN CÔNG NGAY" -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2"></i>Hủy
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-2"></i>Tạo nhân viên
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        // ✅ Toggle password visibility
        document.getElementById('togglePassword')?.addEventListener('click', function() {
            const passwordInput = document.getElementById('passwordInput');
            const icon = this.querySelector('i');
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('bi-eye');
                icon.classList.add('bi-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('bi-eye-slash');
                icon.classList.add('bi-eye');
            }
        });

        document.getElementById('toggleConfirmPassword')?.addEventListener('click', function() {
            const confirmPasswordInput = document.getElementById('confirmPasswordInput');
            const icon = this.querySelector('i');
            if (confirmPasswordInput.type === 'password') {
                confirmPasswordInput.type = 'text';
                icon.classList.remove('bi-eye');
                icon.classList.add('bi-eye-slash');
            } else {
                confirmPasswordInput.type = 'password';
                icon.classList.remove('bi-eye-slash');
                icon.classList.add('bi-eye');
            }
        });

        // ✅ Password validation
        document.getElementById('createStaffForm')?.addEventListener('submit', function(e) {
            const password = document.getElementById('passwordInput').value;
            const confirmPassword = document.getElementById('confirmPasswordInput').value;
            
            if (password !== confirmPassword) {
                e.preventDefault();
                alert('Mật khẩu xác nhận không khớp!');
                return false;
            }
        });

        // ✅ Auto-hide modal after successful submission
        @if (!string.IsNullOrEmpty(Model.SuccessMessage) && Model.SuccessMessage.Contains("Đã tạo nhân viên mới"))
        {
            <text>
            var modal = bootstrap.Modal.getInstance(document.getElementById('createStaffModal'));
            if (modal) {
                modal.hide();
            }
            </text>
        }
    </script>
}

<style>
    @@keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
    }
    
    .table-success {
        background-color: rgba(25, 135, 84, 0.05) !important;
    }
    
    .card.border-success {
        border-width: 2px !important;
    }
    
    .card.border-warning {
        border-width: 2px !important;
    }
    
    .card.border-danger {
        border-width: 2px !important;
    }
</style>
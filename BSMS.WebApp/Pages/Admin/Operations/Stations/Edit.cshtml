@page "/Admin/Operations/Stations/Edit/{stationId?}"
@model BSMS.WebApp.Pages.Admin.Operations.Stations.EditModel
@{
    ViewData["Title"] = Model.StationForm.StationId == 0 ? "T·∫°o tr·∫°m m·ªõi" : "C·∫≠p nh·∫≠t tr·∫°m";
}

@section Styles {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <style>
        #stationMap {
            height: 450px;
            width: 100%;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            z-index: 1;
        }
        
        /* Fix leaflet controls z-index */
        .leaflet-control-container {
            z-index: 1000;
        }
        
        /* Loading indicator */
        .map-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
    </style>
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-8">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-bottom">
                    <h4 class="mb-0">
                        <i class="bi bi-geo-alt-fill text-primary me-2"></i>@ViewData["Title"]
                    </h4>
                    <small class="text-muted">ƒêi·ªÅn th√¥ng tin tr·∫°m v√† ch·ªçn v·ªã tr√≠ tr√™n b·∫£n ƒë·ªì.</small>
                </div>
                <div class="card-body">
                    @if (TempData.ContainsKey("SuccessMessage"))
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="bi bi-check-circle me-2"></i>@TempData["SuccessMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }
                    
                    <form method="post">
                        <input asp-for="StationForm.StationId" type="hidden" />
                        <input asp-for="ReturnUrl" type="hidden" />
                        <div asp-validation-summary="All" class="alert alert-danger" role="alert"></div>
                        
                        <div class="mb-3">
                            <label asp-for="StationForm.Name" class="form-label fw-semibold">
                                <i class="bi bi-building me-1"></i>T√™n tr·∫°m
                            </label>
                            <input asp-for="StationForm.Name" class="form-control" placeholder="VD: Tr·∫°m ƒë·ªïi pin Qu·∫≠n 1" />
                            <span asp-validation-for="StationForm.Name" class="text-danger small"></span>
                        </div>
                        
                        <div class="mb-3">
                            <label asp-for="StationForm.Address" class="form-label fw-semibold">
                                <i class="bi bi-pin-map me-1"></i>ƒê·ªãa ch·ªâ
                            </label>
                            <input asp-for="StationForm.Address" 
                                   class="form-control" 
                                   id="stationAddressInput"
                                   list="addressSuggestions"
                                   placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ v√† ch·ªçn t·ª´ g·ª£i √Ω..." />
                            <datalist id="addressSuggestions"></datalist>
                            <span asp-validation-for="StationForm.Address" class="text-danger small"></span>
                            <small class="text-muted d-block mt-1">
                                <i class="bi bi-info-circle me-1"></i>G√µ √≠t nh·∫•t 3 k√Ω t·ª± ƒë·ªÉ nh·∫≠n g·ª£i √Ω ƒë·ªãa ch·ªâ.
                            </small>
                        </div>
                        
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label asp-for="StationForm.Latitude" class="form-label fw-semibold">
                                    <i class="bi bi-compass me-1"></i>Vƒ© ƒë·ªô (Latitude)
                                </label>
                                <input asp-for="StationForm.Latitude" 
                                       class="form-control" 
                                       type="number" 
                                       step="0.000001"
                                       data-val-regex="Vƒ© ƒë·ªô ch·ªâ ƒë∆∞·ª£c ph√©p t·ªëi ƒëa 6 ch·ªØ s·ªë th·∫≠p ph√¢n (v√≠ d·ª•: 10.844445)"
                                       data-val-regex-pattern="^-?\d+(\.\d{1,6})?$"
                                       id="stationLatitudeInput" />
                                <span asp-validation-for="StationForm.Latitude" class="text-danger"></span>
                                <small class="text-muted">T·ªëi ƒëa 6 ch·ªØ s·ªë th·∫≠p ph√¢n</small>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="StationForm.Longitude" class="form-label fw-semibold">
                                    <i class="bi bi-compass me-1"></i>Kinh ƒë·ªô (Longitude)
                                </label>
                                <input asp-for="StationForm.Longitude" 
                                       class="form-control" 
                                       type="number" 
                                       step="0.000001"
                                       data-val-regex="Kinh ƒë·ªô ch·ªâ ƒë∆∞·ª£c ph√©p t·ªëi ƒëa 6 ch·ªØ s·ªë th·∫≠p ph√¢n (v√≠ d·ª•: 106.715696)"
                                       data-val-regex-pattern="^-?\d+(\.\d{1,6})?$"
                                       id="stationLongitudeInput" />
                                <span asp-validation-for="StationForm.Longitude" class="text-danger"></span>
                                <small class="text-muted">T·ªëi ƒëa 6 ch·ªØ s·ªë th·∫≠p ph√¢n</small>
                            </div>
                        </div>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label asp-for="StationForm.Capacity" class="form-label fw-semibold">
                                    <i class="bi bi-battery-charging me-1"></i>S·ª©c ch·ª©a
                                </label>
                                <input asp-for="StationForm.Capacity" class="form-control" type="number" min="1" />
                                <span asp-validation-for="StationForm.Capacity" class="text-danger small"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="StationForm.Status" class="form-label fw-semibold">
                                    <i class="bi bi-toggle-on me-1"></i>Tr·∫°ng th√°i
                                </label>
                                <select asp-for="StationForm.Status" class="form-select" asp-items="Model.StationStatusOptions"></select>
                                <span asp-validation-for="StationForm.Status" class="text-danger small"></span>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label fw-semibold mb-2">
                                <i class="bi bi-map me-1"></i>V·ªã tr√≠ tr√™n b·∫£n ƒë·ªì
                            </label>
                            <div style="position: relative;">
                                <div id="stationMap"></div>
                                <div id="mapLoading" class="map-loading" style="display: none;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mb-0 mt-2 small">ƒêang t·∫£i b·∫£n ƒë·ªì...</p>
                                </div>
                            </div>
                            <small class="text-muted d-block mt-2">
                                <i class="bi bi-hand-index me-1"></i>
                                Nh·∫•n v√†o b·∫£n ƒë·ªì ho·∫∑c k√©o marker (üìç) ƒë·ªÉ ch·ªçn v·ªã tr√≠ ch√≠nh x√°c.
                            </small>
                        </div>
                        
                        <hr class="my-4" />
                        
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary px-4">
                                <i class="bi bi-save me-1"></i>L∆∞u tr·∫°m
                            </button>
                            <a class="btn btn-outline-secondary px-4" 
                               href="@(Model.ReturnUrl ?? Url.Page("/Admin/Operations/Index"))">
                                <i class="bi bi-x-circle me-1"></i>H·ªßy
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <script>
        (function() {
            'use strict';
            
            console.log('[Map] Script started');
            
            const config = {
                defaultPosition: { lat: 10.8144, lng: 106.7102 },
                defaultZoom: 15, // ‚úÖ Zoom in more for better view
                minZoom: 5,
                maxZoom: 19,
                debounceDelay: 500 // ‚úÖ Faster response
            };
            
            let map = null;
            let marker = null;
            let geocodeTimer = null;
            let tileLayer = null;
            
            const mapContainer = document.getElementById('stationMap');
            const mapLoading = document.getElementById('mapLoading');
            const latInput = document.getElementById('stationLatitudeInput');
            const lngInput = document.getElementById('stationLongitudeInput');
            const addressInput = document.getElementById('stationAddressInput');
            
            // ‚úÖ WORKING TILE PROVIDERS (tested)
            const tileProviders = [
                {
                    name: 'CartoDB Voyager',
                    url: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
                    attribution: '&copy; OpenStreetMap, &copy; CARTO',
                    maxZoom: 19
                },
                {
                    name: 'OSM Standard',
                    url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                    attribution: '&copy; OpenStreetMap contributors',
                    maxZoom: 19
                }
            ];
            
            let currentProviderIndex = 0;
            
            function initMap() {
                console.log('[Map] Initializing map container...');
                
                if (!mapContainer) {
                    console.error('[Map] Map container not found!');
                    return;
                }
                
                showLoading(true);
                
                try {
                    // Get initial coordinates
                    const initialLat = parseFloat(latInput?.value) || config.defaultPosition.lat;
                    const initialLng = parseFloat(lngInput?.value) || config.defaultPosition.lng;
                    
                    console.log('[Map] Initial position:', initialLat, initialLng);
                    
                    // Create map
                    map = L.map(mapContainer, {
                        center: [initialLat, initialLng],
                        zoom: config.defaultZoom,
                        zoomControl: true,
                        attributionControl: true
                    });
                    
                    console.log('[Map] Map object created');
                    
                    // Load tiles
                    loadTileLayer();
                    
                    // Create draggable marker
                    marker = L.marker([initialLat, initialLng], {
                        draggable: true,
                        title: 'V·ªã tr√≠ tr·∫°m ƒë·ªïi pin'
                    }).addTo(map);
                    
                    marker.bindPopup('üìç V·ªã tr√≠ tr·∫°m ƒë·ªïi pin').openPopup();
                    
                    console.log('[Map] Marker created');
                    
                    // ‚úÖ Event listeners
                    marker.on('dragend', function(e) {
                        const pos = e.target.getLatLng();
                        console.log('[Map] Marker dragged to:', pos.lat, pos.lng);
                        updatePosition(pos.lat, pos.lng, true);
                    });
                    
                    map.on('click', function(e) {
                        console.log('[Map] Map clicked at:', e.latlng.lat, e.latlng.lng);
                        updatePosition(e.latlng.lat, e.latlng.lng, true);
                    });
                    
                    // ‚úÖ Force map to render properly
                    setTimeout(() => {
                        if (map) {
                            map.invalidateSize();
                            console.log('[Map] Size invalidated');
                        }
                        showLoading(false);
                    }, 300);
                    
                    console.log('[Map] Initialization complete');
                    
                } catch (error) {
                    console.error('[Map] Initialization error:', error);
                    showLoading(false);
                    alert('Kh√¥ng th·ªÉ t·∫£i b·∫£n ƒë·ªì. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet.');
                }
            }
            
            function loadTileLayer() {
                if (!map) return;
                
                // Remove old layer
                if (tileLayer) {
                    map.removeLayer(tileLayer);
                    console.log('[Map] Removed old tile layer');
                }
                
                const provider = tileProviders[currentProviderIndex];
                console.log(`[Map] Loading tiles from: ${provider.name}`);
                
                tileLayer = L.tileLayer(provider.url, {
                    attribution: provider.attribution,
                    maxZoom: provider.maxZoom,
                    subdomains: ['a', 'b', 'c'],
                    crossOrigin: true
                });
                
                // ‚úÖ Error handling
                tileLayer.on('tileerror', function(error) {
                    console.error(`[Map] Tile error from ${provider.name}:`, error);
                    
                    // Try next provider
                    if (currentProviderIndex < tileProviders.length - 1) {
                        currentProviderIndex++;
                        console.warn(`[Map] Switching to: ${tileProviders[currentProviderIndex].name}`);
                        setTimeout(loadTileLayer, 500);
                    } else {
                        console.error('[Map] All tile providers failed!');
                        alert('Kh√¥ng th·ªÉ t·∫£i b·∫£n ƒë·ªì. Vui l√≤ng th·ª≠ l·∫°i sau.');
                    }
                });
                
                tileLayer.on('tileloadstart', function() {
                    console.log('[Map] Tiles loading...');
                });
                
                tileLayer.on('tileload', function() {
                    console.log('[Map] Tile loaded successfully');
                });
                
                tileLayer.on('load', function() {
                    console.log('[Map] All tiles loaded!');
                });
                
                tileLayer.addTo(map);
            }
            
            function updatePosition(lat, lng, shouldReverseGeocode = false) {
                // Validate
                if (typeof lat !== 'number' || isNaN(lat) || lat < -90 || lat > 90) {
                    console.warn('[Map] Invalid latitude:', lat);
                    return;
                }
                if (typeof lng !== 'number' || isNaN(lng) || lng < -180 || lng > 180) {
                    console.warn('[Map] Invalid longitude:', lng);
                    return;
                }
                
                // Round to 6 decimals
                const roundedLat = Math.round(lat * 1000000) / 1000000;
                const roundedLng = Math.round(lng * 1000000) / 1000000;
                
                console.log('[Map] Updating position:', roundedLat, roundedLng);
                
                // Update inputs
                if (latInput) latInput.value = roundedLat.toFixed(6);
                if (lngInput) lngInput.value = roundedLng.toFixed(6);
                
                // Update marker
                if (marker) {
                    marker.setLatLng([roundedLat, roundedLng]);
                    marker.openPopup();
                }
                
                // Pan map
                if (map) {
                    map.panTo([roundedLat, roundedLng]);
                }
                
                // ‚úÖ Reverse geocode with debounce
                if (shouldReverseGeocode) {
                    clearTimeout(geocodeTimer);
                    geocodeTimer = setTimeout(() => {
                        console.log('[Map] Starting reverse geocode...');
                        reverseGeocode(roundedLat, roundedLng);
                    }, config.debounceDelay);
                }
            }
            
            async function reverseGeocode(lat, lng) {
                if (!addressInput) return;
                
                console.log('[Geocode] Reverse geocoding:', lat, lng);
                
                try {
                    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=vi`;
                    console.log('[Geocode] Request URL:', url);
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'User-Agent': 'BSMS-Station-Manager/1.0 (Contact: admin@bsms.com)',
                            'Accept': 'application/json'
                        }
                    });
                    
                    console.log('[Geocode] Response status:', response.status);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('[Geocode] Response data:', data);
                        
                        if (data && data.display_name) {
                            addressInput.value = data.display_name;
                            console.log('[Geocode] Address updated:', data.display_name);
                        } else {
                            console.warn('[Geocode] No display_name in response');
                            addressInput.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                        }
                    } else {
                        console.error('[Geocode] HTTP error:', response.status, response.statusText);
                        addressInput.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    }
                } catch (error) {
                    console.error('[Geocode] Exception:', error);
                    if (addressInput) {
                        addressInput.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    }
                }
            }
            
            function showLoading(show) {
                if (mapLoading) {
                    mapLoading.style.display = show ? 'block' : 'none';
                }
            }
            
            // ‚úÖ Initialize when page is fully loaded
            window.addEventListener('load', function() {
                console.log('[Map] Window loaded, initializing map...');
                setTimeout(initMap, 200);
            });
            
            // Fallback if window load already fired
            if (document.readyState === 'complete') {
                console.log('[Map] Document already complete, initializing immediately...');
                setTimeout(initMap, 200);
            }
            
        })();
    </script>
}

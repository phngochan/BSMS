@page
@using BSMS.BusinessObjects.Enums
@using System.Text.Json
@using System.Linq
@model BSMS.WebApp.Pages.Admin.Operations.IndexModel
@{
    ViewData["Title"] = "VẬN HÀNH & GIÁM SÁT HỆ THỐNG";
}

@functions {
    public static string GetStationBadgeClass(StationStatus status) => status switch
    {
        StationStatus.Active => "badge bg-success text-white fw-semibold",
        StationStatus.Maintenance => "badge bg-warning text-dark fw-semibold",
        StationStatus.Inactive => "badge bg-secondary text-white fw-semibold",
        _ => "badge bg-light text-dark border fw-semibold"
    };

    public static string GetTransferBadgeClass(TransferStatus status) => status switch
    {
        TransferStatus.InProgress => "badge bg-info text-white fw-semibold",
        TransferStatus.Completed => "badge bg-success text-white fw-semibold",
        TransferStatus.Cancelled => "badge bg-secondary text-white fw-semibold",
        TransferStatus.Rejected => "badge bg-danger text-white fw-semibold", // ✅ MỚI
        _ => "badge bg-light text-dark border fw-semibold"
    };

    public static string GetSupportBadgeClass(SupportStatus status) => status switch
    {
        SupportStatus.Open => "badge bg-danger text-white fw-semibold",
        SupportStatus.InProgress => "badge bg-warning text-dark fw-semibold",
        SupportStatus.Closed => "badge bg-success text-white fw-semibold",
        _ => "badge bg-light text-dark border fw-semibold"
    };

    public static string GetSwapBadgeClass(SwapStatus status) => status switch
    {
        SwapStatus.Pending => "badge bg-warning text-dark fw-semibold",
        SwapStatus.Completed => "badge bg-success text-white fw-semibold",
        SwapStatus.Cancelled => "badge bg-danger text-white fw-semibold",
        _ => "badge bg-light text-dark border fw-semibold"
    };

    public static string GetBatteryBadgeClass(BatteryStatus status) => status switch
    {
        BatteryStatus.Full => "badge bg-success text-white fw-semibold",
        BatteryStatus.Charging => "badge bg-info text-white fw-semibold",
        BatteryStatus.Taken => "badge bg-warning text-dark fw-semibold",
        BatteryStatus.Booked => "badge bg-primary text-white fw-semibold",
        BatteryStatus.Defective => "badge bg-danger text-white fw-semibold",
        _ => "badge bg-secondary text-white fw-semibold"
    };
}

<div class="container-fluid py-3 operations-wrapper">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
            <div>
                <p class="text-uppercase text-muted fw-semibold mb-1">Luồng vận hành và giám sát</p>
                <h2 class="fw-bold mb-0">@ViewData["Title"]</h2>
                <p class="text-muted mb-0">Chọn tab phù hợp với hành động bạn muốn thực hiện.</p>
            </div>
        <span class="badge bg-success-subtle text-success-emphasis px-3 py-2 mt-3 mt-md-0">
            <i class="bi bi-activity me-2"></i>Last updated @Model.Overview.GeneratedAt.ToLocalTime().ToString("HH:mm:ss")
        </span>
    </div>

    <ul class="nav nav-pills flex-wrap gap-2" id="operationsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#tab-overview" type="button" role="tab">Tổng quan</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="stations-tab" data-bs-toggle="tab" data-bs-target="#tab-stations" type="button" role="tab">Trạm & Pin</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="transfer-tab" data-bs-toggle="tab" data-bs-target="#tab-transfer" type="button" role="tab">Đơn điều phối</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="staff-tab" data-bs-toggle="tab" data-bs-target="#tab-staff" type="button" role="tab">Nhân sự trạm</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="support-tab" data-bs-toggle="tab" data-bs-target="#tab-support" type="button" role="tab">Hỗ trợ</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="swap-tab" data-bs-toggle="tab" data-bs-target="#tab-swap" type="button" role="tab">Giao dịch đổi pin</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="config-tab" data-bs-toggle="tab" data-bs-target="#tab-config" type="button" role="tab">Cấu hình</button>
        </li>
    </ul>

    <div class="tab-content mt-4" id="operationsTabContent">
        <!-- Overview -->
        <div class="tab-pane fade show active" id="tab-overview" role="tabpanel" aria-labelledby="overview-tab">
            <div class="row g-3 mb-4">
                <div class="col-12 col-md-3">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-muted text-uppercase small mb-1">Trạm đang hoạt động</p>
                                <div class="fs-2 fw-bold">@Model.Overview.StationCount</div>
                                <small class="text-success">@Model.Overview.ActiveStationCount đang hoạt động</small>
                            </div>
                            <i class="bi bi-ev-station text-success fs-1"></i>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-3">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-muted text-uppercase small mb-1">Tồn kho pin</p>
                                <div class="fs-2 fw-bold">@Model.Overview.BatteryTotal</div>
                                <small class="text-primary">@Model.Overview.TransfersInProgress đang điều phối</small>
                            </div>
                            <i class="bi bi-battery-charging text-primary fs-1"></i>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-3">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-muted text-uppercase small mb-1">Ticket mở</p>
                                <div class="fs-2 fw-bold">@Model.Overview.OpenSupports</div>
                                <small class="text-warning">Cần lưu ý</small>
                            </div>
                            <i class="bi bi-life-preserver text-warning fs-1"></i>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-3">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-muted text-uppercase small mb-1">Doanh thu</p>
                                <div class="fs-2 fw-bold">@Model.Overview.MonthlyRevenue.ToString("C0")</div>
                                <small class="text-info">@Model.Overview.DailyTransactions giao dịch/ngày</small>
                            </div>
                            <i class="bi bi-currency-exchange text-info fs-1"></i>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-3">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-muted text-uppercase small mb-1">Hàng chờ tài xế (6h)</p>
                                <div class="fs-2 fw-bold">@Model.Overview.DriverQueueCount</div>
                                @{
                                    var nextReservation = Model.UpcomingReservations.FirstOrDefault();
                                    var nextSlot = nextReservation?.ScheduledTime.ToLocalTime().ToString("HH:mm");
                                }
                                    <small class="text-danger">
                                        @(nextSlot is not null ? $"Lần lấy tiếp theo {nextSlot}" : "Chưa có tài xế được lên lịch")
                                    </small>
                            </div>
                            <i class="bi bi-person-raised-hand text-danger fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-12 col-xl-8">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-header bg-white border-0">
                            <h5 class="mb-0">Luồng tài xế (6h tới)</h5>
                            <small class="text-muted">Phối tài xế sắp tới với pin đã chuẩn bị.</small>
                        </div>
                        <div class="card-body">
                            @if (Model.UpcomingReservations.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-sm align-middle mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Tài xế</th>
                                                <th>Trạm &amp; ca</th>
                                                <th>Pin</th>
                                                <th class="text-end">Trạng thái</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var reservation in Model.UpcomingReservations)
                                            {
                                                var driverName = reservation.User?.FullName ?? reservation.User?.Username ?? $"User #{reservation.UserId}";
                                                var vehicleModel = reservation.Vehicle?.Vin ?? "Unknown Vehicle";
                                                var scheduledTime = reservation.ScheduledTime.ToLocalTime().ToString("HH:mm dd/MM");
                                                var batteryLabel = reservation.BatteryId?.ToString() ?? "--";
                                                <tr>
                                                    <td class="fw-semibold">
                                                        @driverName
                                                        <div class="small text-muted">@vehicleModel</div>
                                                    </td>
                                                    <td>
                                                        <div class="fw-semibold">
                                                            @(reservation.Station?.Name ?? $"Station #{reservation.StationId}")
                                                        </div>
                                                        <small class="text-muted">@scheduledTime</small>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-light text-dark border">Battery #@batteryLabel</span>
                                                    </td>
                                                    <td class="text-end">
                                                        <span class="badge bg-info-subtle text-info">@reservation.Status</span>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <p class="text-muted mb-0">Chưa có tài xế trong 6 giờ tới.</p>
                            }
                        </div>
                    </div>
                </div>
                <div class="col-12 col-xl-4">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-header bg-white border-0">
                            <h5 class="mb-0">Trạm cần chuẩn bị</h5>
                            <small class="text-muted">Cảnh báo nếu tài xế đến trước khi pin mới sẵn sàng.</small>
                        </div>
                        <div class="card-body">
                            @{
                                var attentionStations = Model.StationDriverSignals.Values
                                    .Where(s => s.NeedsAttention)
                                    .OrderByDescending(s => s.PendingReservations)
                                    .ToList();
                            }
                            @if (attentionStations.Any())
                            {
                                <div class="list-group list-group-flush">
                                    @foreach (var signal in attentionStations)
                                    {
                                        <div class="list-group-item border-0 border-bottom d-flex justify-content-between align-items-start">
                                            <div>
                                                <div class="fw-semibold">@signal.StationName</div>
                                                <small class="text-muted d-block">
                                                    Drivers: @signal.PendingReservations &middot;
                                                    Full ready: @signal.FullBatteries &middot;
                                                    Booked: @signal.BookedBatteries
                                                </small>
                                                @if (signal.DriverNames.Any())
                                                {
                                                    <small class="text-muted">Queue: @string.Join(", ", signal.DriverNames)</small>
                                                }
                                                @if (signal.NextReservationTime.HasValue)
                                                {
                                                    <small class="d-block text-muted">
                                                        Next at @signal.NextReservationTime.Value.ToLocalTime().ToString("HH:mm")
                                                    </small>
                                                }
                                            </div>
                                            <span class="badge bg-danger-subtle text-danger">Prep now</span>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-success mb-0">
                                    All scheduled drivers have a ready battery.
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h5 class="mb-1">Battery status overview</h5>
                            <p class="text-muted small mb-0">Monitor battery health by status.</p>
                        </div>
                        <div class="d-flex gap-3 flex-wrap">
                            @foreach (BatteryStatus status in Enum.GetValues(typeof(BatteryStatus)))
                            {
                                var count = Model.Overview.BatteryStatusSummary.TryGetValue(status, out var value)
                                    ? value : 0;
                                <div class="text-center px-3 py-2 rounded bg-light">
                                    <p class="small text-muted mb-0">@status</p>
                                    <div class="fs-5 fw-semibold">@count</div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stations & Batteries -->
        <div class="tab-pane fade" id="tab-stations" role="tabpanel" aria-labelledby="stations-tab">
            <div class="row g-4 mb-4">
                <div class="col-12">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-0">Trạm đổi pin</h5>
                                <small class="text-muted">Theo dõi trạng thái và sức chứa trạm</small>
                            </div>
                            <a class="btn btn-primary btn-sm" asp-page="/Admin/Operations/Stations/Edit" asp-route-returnUrl="@Url.Page("/Admin/Operations/Index")">
                                <i class="bi bi-plus-lg me-1"></i>Tạo trạm
                            </a>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0 align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Tên trạm</th>
                                            <th>Địa chỉ</th>
                                            <th>Sức chứa</th>
                                            <th>Pin</th>
                                            <th>Tài xế</th>
                                            <th>Trạng thái</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var station in Model.Stations)
                                        {
                                            var batteryGroups = station.Batteries?
                                                .GroupBy(b => b.Status)
                                                .ToDictionary(g => g.Key, g => g.Count()) ?? new Dictionary<BatteryStatus, int>();
                                            <tr>
                                                <td class="fw-semibold">@station.Name</td>
                                                <td>@station.Address</td>
                                                <td>@station.Capacity</td>
                                                <td>
                                                    <div class="d-flex gap-2 flex-wrap">
                                                        @foreach (BatteryStatus status in Enum.GetValues(typeof(BatteryStatus)))
                                                        {
                                                            var value = batteryGroups.TryGetValue(status, out var v) ? v : 0;
                                                            <span class="badge bg-light text-dark border">@status: @value</span>
                                                        }
                                                    </div>
                                                </td>
                                                <td>
                                                    @if (Model.StationDriverSignals.TryGetValue(station.StationId, out var driverSignal))
                                                    {
                                                        <div class="d-flex flex-column gap-1">
                                                            <span>@driverSignal.PendingReservations lượt tài xế chờ</span>
                                                            <span>@driverSignal.DriverNames.Count tài xế</span>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted small">Không có hàng chờ</span>
                                                    }
                                                </td>
                                                <td>
                                                    @{ var stationBadgeClass = GetStationBadgeClass(station.Status); }
                                                    <span class="@stationBadgeClass">@station.Status</span>
                                                    @if (Model.IdleStations.Contains(station.StationId))
                                                    {
                                                        <span class="badge bg-danger text-white ms-1" title="Trạm không có giao dịch trong 12h">Không có trao đổi trong 12h</span>
                                                    }
                                                    @if (Model.StationsWithoutStaff.Contains(station.StationId))
                                                    {
                                                        <span class="badge bg-warning text-dark ms-1" title="Trạm hoạt động nhưng không có nhân sự">&#9888; Chưa có nhân sự</span>
                                                    }
                                                </td>
                                                <td class="text-end">
                                                    <div class="btn-group btn-group-sm">
                                                        <button type="button"
                                                                class="btn btn-outline-secondary station-edit-btn"
                                                                data-station-id="@station.StationId"
                                                                title="Edit station">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <form method="post" asp-page-handler="DeleteStation" class="d-inline"
                                                              onsubmit="return confirm('Delete station @station.Name?');">
                                                            <input type="hidden" name="stationId" value="@station.StationId" />
                                                            <button class="btn btn-outline-danger">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </form>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                        @if (!Model.Stations.Any())
                                        {
                                            <tr>
                                                <td colspan="7" class="text-center text-muted py-4">No station data available yet.</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>        <!-- Transfers -->
        @await Html.PartialAsync("_TransferTab", Model)        <!-- Station Staff -->
        <div class="tab-pane fade" id="tab-staff" role="tabpanel" aria-labelledby="staff-tab">
            <div class="row g-4">
                <!-- FORM PHÂN CÔNG NẰM TRÊN -->
                <div class="col-12">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-header bg-white border-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-0">Phân công nhân sự</h5>
                                    <small class="text-muted">Phân công nhân viên vào trạm với ca làm việc cụ thể.</small>
                                </div>
                                <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#staffEditorCollapse">
                                    <i class="bi bi-pencil-square me-1"></i>Editor
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="collapse" id="staffEditorCollapse">
                                <form method="post" asp-page-handler="SaveStationStaff" id="staffForm" class="row g-3">
                                    <input asp-for="StationStaffForm.StaffId" type="hidden" />
                                    @if (Model.ActiveForm == nameof(Model.StationStaffForm))
                                    {
                                        <div asp-validation-summary="All" class="text-danger small"></div>
                                    }
                                    <div class="col-md-3">
                                        <label asp-for="StationStaffForm.UserId" class="form-label"></label>
                                        <select asp-for="StationStaffForm.UserId" class="form-select" asp-items="Model.StaffUserOptions">
                                            <option value="">-- Chọn nhân sự --</option>
                                        </select>
                                        <span asp-validation-for="StationStaffForm.UserId" class="text-danger small"></span>
                                    </div>
                                    <div class="col-md-3">
                                        <label asp-for="StationStaffForm.StationId" class="form-label"></label>
                                        <select asp-for="StationStaffForm.StationId" class="form-select" asp-items="Model.StationOptions">
                                            <option value="">-- Chọn trạm --</option>
                                        </select>
                                        <span asp-validation-for="StationStaffForm.StationId" class="text-danger small"></span>
                                    </div>
                                    <div class="col-md-3">
                                        <label asp-for="StationStaffForm.ShiftStart" class="form-label">Giờ bắt đầu ca</label>
                                        <input asp-for="StationStaffForm.ShiftStart" class="form-control" type="time" />
                                        <span asp-validation-for="StationStaffForm.ShiftStart" class="text-danger small"></span>
                                    </div>
                                    <div class="col-md-3">
                                        <label asp-for="StationStaffForm.ShiftEnd" class="form-label">Giờ kết thúc ca</label>
                                        <input asp-for="StationStaffForm.ShiftEnd" class="form-control" type="time" />
                                        <span asp-validation-for="StationStaffForm.ShiftEnd" class="text-danger small"></span>
                                    </div>
                                    <div class="col-md-3">
                                        <label asp-for="StationStaffForm.AssignedAt" class="form-label"></label>
                                        <input asp-for="StationStaffForm.AssignedAt" class="form-control" type="datetime-local" />
                                        <span asp-validation-for="StationStaffForm.AssignedAt" class="text-danger small"></span>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Trạng thái</label>
                                        <div class="form-check form-switch mt-2">
                                            <input asp-for="StationStaffForm.IsActive" class="form-check-input" type="checkbox" role="switch" />
                                            <label asp-for="StationStaffForm.IsActive" class="form-check-label">Đang làm việc</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 d-flex align-items-end">
                                        <div class="d-flex gap-2 w-100">
                                            <button type="submit" class="btn btn-primary flex-fill">
                                                <i class="bi bi-people-fill me-1"></i>Lưu
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary flex-fill" data-reset-target="staffForm">
                                                <i class="bi bi-arrow-counterclockwise me-1"></i>Mới
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <p class="small text-muted mb-0 mt-2">Nhấn nút <strong>Editor</strong> để phân công hoặc cập nhật nhân sự.</p>
                        </div>
                    </div>
                </div>

                <!-- BẢNG DANH SÁCH PHÂN CÔNG -->
                <div class="col-12">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-header bg-white border-0">
                            <h5 class="mb-0">Danh sách phân công nhân sự trạm</h5>
                            <small class="text-muted">Quản lý phân công và ca làm việc.</small>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm align-middle table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Nhân sự</th>
                                            <th>Trạm</th>
                                            <th>Ca làm việc</th>
                                            <th>Ngày phân công</th>
                                            <th>Trạng thái</th>
                                            <th class="text-end">Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var staff in Model.Assignments)
                                        {
                                            <tr>
                                                <td>
                                                    <div class="fw-semibold">@staff.User?.FullName</div>
                                                    <small class="text-muted">@staff.User?.Username</small>
                                                </td>
                                                <td>@staff.Station?.Name</td>
                                                <td>
                                                    <div class="fw-semibold">
                                                        @staff.ShiftStart.ToString(@"hh\:mm") - @staff.ShiftEnd.ToString(@"hh\:mm")
                                                    </div>
                                                    <small class="text-muted">
                                                        (@((staff.ShiftEnd - staff.ShiftStart).TotalHours.ToString("0.#")) giờ)
                                                    </small>
                                                </td>
                                                <td>@staff.AssignedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</td>
                                                <td>
                                                    @if (staff.IsActive)
                                                    {
                                                        <span class="badge bg-success text-white">Đang làm việc</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-secondary text-white">Nghỉ việc</span>
                                                    }
                                                </td>
                                                <td class="text-end">
                                                    <div class="btn-group btn-group-sm">
                                                        <button type="button"
                                                                class="btn btn-outline-secondary staff-edit-btn"
                                                                title="Chỉnh sửa"
                                                                data-payload='@Html.Raw(JsonSerializer.Serialize(new {
                                                                    StaffId = staff.StaffId,
                                                                    staff.UserId,
                                                                    staff.StationId,
                                                                    AssignedAt = staff.AssignedAt.ToString("yyyy-MM-ddTHH:mm"),
                                                                    ShiftStart = staff.ShiftStart.ToString(@"hh\:mm"),
                                                                    ShiftEnd = staff.ShiftEnd.ToString(@"hh\:mm"),
                                                                    staff.IsActive
                                                                }))'>
                                                            <i class="bi bi-pencil-square"></i>
                                                        </button>
                                                        <form method="post" asp-page-handler="DeleteStationStaff" class="d-inline"
                                                              onsubmit="return confirm('Gỡ nhân sự này?');">
                                                            <input type="hidden" name="staffId" value="@staff.StaffId" />
                                                            <button class="btn btn-outline-danger" type="submit" title="Xóa">
                                                                <i class="bi bi-x-lg"></i>
                                                            </button>
                                                        </form>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                        @if (!Model.Assignments.Any())
                                        {
                                            <tr>
                                                <td colspan="6" class="text-center text-muted py-4">Chưa có phân công nào.</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Support -->
        <div class="tab-pane fade" id="tab-support" role="tabpanel" aria-labelledby="support-tab">
            <div class="row g-4 mb-4">
                <div class="col-12">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-0">Danh sách yêu cầu hỗ trợ</h5>
                                <small class="text-muted">Theo dõi và quản lý các ticket hỗ trợ</small>
                            </div>
                            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="collapse" data-bs-target="#supportEditorCollapse">
                                <i class="bi bi-plus-lg me-1"></i>Tạo ticket
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <!-- Form tạo/cập nhật ticket (ẩn mặc định) -->
                            <div class="collapse" id="supportEditorCollapse">
                                <div class="border-bottom p-3 bg-light">
                                    <form method="post" asp-page-handler="SaveSupport" id="supportForm">
                                        <input asp-for="SupportForm.SupportId" type="hidden" />
                                        @if (Model.ActiveForm == nameof(Model.SupportForm))
                                        {
                                            <div asp-validation-summary="All" class="text-danger small mb-2"></div>
                                        }
                                        <div class="row g-3">
                                            <div class="col-md-3">
                                                <label asp-for="SupportForm.UserId" class="form-label">Người yêu cầu</label>
                                                <select asp-for="SupportForm.UserId" class="form-select form-select-sm" asp-items="Model.SupportUserOptions">
                                                    <option value="">-- Chọn người yêu cầu --</option>
                                                </select>
                                                <span asp-validation-for="SupportForm.UserId" class="text-danger small"></span>
                                            </div>
                                            <div class="col-md-3">
                                                <label asp-for="SupportForm.StationId" class="form-label">Trạm</label>
                                                <select asp-for="SupportForm.StationId" class="form-select form-select-sm" asp-items="Model.StationOptions">
                                                    <option value="">-- Chọn trạm --</option>
                                                </select>
                                                <span asp-validation-for="SupportForm.StationId" class="text-danger small"></span>
                                            </div>
                                            <div class="col-md-2">
                                                <label asp-for="SupportForm.Type" class="form-label">Loại</label>
                                                <select asp-for="SupportForm.Type" class="form-select form-select-sm" asp-items="Model.SupportTypeOptions"></select>
                                                <span asp-validation-for="SupportForm.Type" class="text-danger small"></span>
                                            </div>
                                            <div class="col-md-2">
                                                <label asp-for="SupportForm.Status" class="form-label">Trạng thái</label>
                                                <select asp-for="SupportForm.Status" class="form-select form-select-sm" asp-items="Model.SupportStatusOptions"></select>
                                                <span asp-validation-for="SupportForm.Status" class="text-danger small"></span>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label">Đánh giá</label>
                                                <input name="SupportForm.Rating" class="form-control form-control-sm" value="@(Model.SupportForm.Rating.HasValue ? Model.SupportForm.Rating.Value + " ★" : "Chưa có")" readonly />
                                            </div>
                                            <div class="col-md-6">
                                                <label asp-for="SupportForm.Description" class="form-label">Mô tả</label>
                                                <textarea asp-for="SupportForm.Description" class="form-control form-control-sm" rows="2" placeholder="Nhập mô tả chi tiết..."></textarea>
                                                <span asp-validation-for="SupportForm.Description" class="text-danger small"></span>
                                            </div>
                                            <div class="col-md-6">
                                                <label asp-for="SupportForm.StaffNote" class="form-label">Ghi chú nội bộ</label>
                                                <textarea asp-for="SupportForm.StaffNote" class="form-control form-control-sm" rows="2" placeholder="Ghi chú cho nhân viên..."></textarea>
                                                <span asp-validation-for="SupportForm.StaffNote" class="text-danger small"></span>
                                            </div>
                                            <div class="col-12">
                                                @{
                                                    var isClosedSupport = Model.SupportForm.SupportId != 0 && Model.SupportForm.Status == SupportStatus.Closed;
                                                }
                                                @if (isClosedSupport)
                                                {
                                                    <div class="alert alert-warning small mb-2">
                                                        Ticket đã đóng, nhấn <strong>Mới</strong> để tạo yêu cầu mới.
                                                    </div>
                                                }
                                                <div class="d-flex gap-2">
                                                    <button type="submit" class="btn btn-primary btn-sm" @(isClosedSupport ? "disabled" : null)>
                                                        <i class="bi bi-save me-1"></i>Lưu
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary btn-sm" data-reset-target="supportForm">
                                                        <i class="bi bi-arrow-counterclockwise me-1"></i>Mới
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#supportEditorCollapse">
                                                        <i class="bi bi-x-lg me-1"></i>Đóng
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- Bảng danh sách ticket -->
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>#</th>
                                            <th>Người yêu cầu</th>
                                            <th>Trạm</th>
                                            <th>Loại</th>
                                            <th>Mô tả</th>
                                            <th>Trạng thái</th>
                                            <th>Đánh giá</th>
                                            <th>Ngày tạo</th>
                                            <th class="text-end">Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var support in Model.Supports)
                                        {
                                            <tr>
                                                <td>@support.SupportId</td>
                                                <td>
                                                    <div class="fw-semibold">@support.User?.FullName</div>
                                                    <small class="text-muted">@support.User?.Username</small>
                                                </td>
                                                <td>@support.Station?.Name</td>
                                                <td>
                                                    <span class="badge bg-light text-dark border">@support.Type</span>
                                                </td>
                                                <td>
                                                    <div style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="@support.Description">
                                                        @support.Description
                                                    </div>
                                                    @if (!string.IsNullOrWhiteSpace(support.StaffNote))
                                                    {
                                                        <small class="text-muted d-block">
                                                            <i class="bi bi-sticky"></i> @support.StaffNote
                                                        </small>
                                                    }
                                                </td>
                                                <td>
                                                    @{
                                                        var supportBadgeClass = GetSupportBadgeClass(support.Status);
                                                    }
                                                    <span class="@supportBadgeClass">@support.Status</span>
                                                </td>
                                                <td>
                                                    @if (support.Rating.HasValue)
                                                    {
                                                        <span class="text-warning">@string.Concat(Enumerable.Repeat("★", support.Rating.Value))</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted small">Chưa đánh giá</span>
                                                    }
                                                </td>
                                                <td>
                                                    <small>@support.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</small>
                                                </td>
                                                <td class="text-end">
                                                    <div class="btn-group btn-group-sm">
                                                        <button type="button"
                                                                class="btn btn-outline-secondary support-edit-btn"
                                                                title="Chỉnh sửa"
                                                                data-payload='@Html.Raw(JsonSerializer.Serialize(new {
                                                                    support.SupportId,
                                                                    support.UserId,
                                                                    support.StationId,
                                                                    Type = support.Type.ToString(),
                                                                    support.Description,
                                                                    Status = support.Status.ToString(),
                                                                    support.Rating,
                                                                    support.StaffNote
                                                                }))'>
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <form method="post" asp-page-handler="DeleteSupport" class="d-inline"
                                                              onsubmit="return confirm('Xóa ticket hỗ trợ này?');">
                                                            <input type="hidden" name="supportId" value="@support.SupportId" />
                                                            <button class="btn btn-outline-danger" type="submit" title="Xóa">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </form>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                        @if (!Model.Supports.Any())
                                        {
                                            <tr>
                                                <td colspan="9" class="text-center text-muted py-4">Chưa có yêu cầu hỗ trợ nào.</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Swap Transactions -->
        <div class="tab-pane fade" id="tab-swap" role="tabpanel" aria-labelledby="swap-tab">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white border-0">
                    <h5 class="mb-0">Giao dịch đổi pin</h5>
                    <small class="text-muted">20 giao dịch gần nhất.</small>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Người dùng</th>
                                    <th>Trạm</th>
                                    <th>Pin</th>
                                    <th>Chi phí</th>
                                    <th>Trạng thái</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var tx in Model.SwapTransactions)
                                {
                                    <tr>
                                        <td>@tx.TransactionId</td>
                                        <td>@tx.User?.FullName <br /><small class="text-muted">@tx.Vehicle?.Vin</small></td>
                                        <td>@tx.Station?.Name</td>
                                        <td>Lấy: #@tx.BatteryTakenId<br />Trả: #@tx.BatteryReturnedId</td>
                                        <td>@tx.TotalCost.ToString("C0")</td>
                                        <td>
                                            @{
                                                var swapBadgeClass = GetSwapBadgeClass(tx.Status);
                                            }
                                            <span class="@swapBadgeClass">@tx.Status</span>
                                        </td>
                                        <td class="text-end">
                                            <div class="btn-group btn-group-sm">
                                                @if (tx.Status == SwapStatus.Pending)
                                                {
                                                    <form method="post" asp-page-handler="UpdateSwapStatus" class="d-inline">
                                                        <input type="hidden" name="transactionId" value="@tx.TransactionId" />
                                                        <input type="hidden" name="status" value="Completed" />
                                                        <button class="btn btn-outline-success" title="Hoàn thành">
                                                            <i class="bi bi-check2"></i>
                                                        </button>
                                                    </form>
                                                    <form method="post" asp-page-handler="UpdateSwapStatus" class="d-inline">
                                                        <input type="hidden" name="transactionId" value="@tx.TransactionId" />
                                                        <input type="hidden" name="status" value="Cancelled" />
                                                        <button class="btn btn-outline-warning" title="Hủy">
                                                            <i class="bi bi-x-circle"></i>
                                                        </button>
                                                    </form>
                                                }
                                                <form method="post" asp-page-handler="DeleteSwap" class="d-inline"
                                                      onsubmit="return confirm('Xóa giao dịch #@tx.TransactionId?');">
                                                    <input type="hidden" name="transactionId" value="@tx.TransactionId" />
                                                    <button class="btn btn-outline-danger" title="Xóa">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                }
                                @if (!Model.SwapTransactions.Any())
                                {
                                    <tr>
                                        <td colspan="7" class="text-center text-muted py-4">Chưa có giao dịch nào.</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuration -->
        <div class="tab-pane fade" id="tab-config" role="tabpanel" aria-labelledby="config-tab">
            <div class="row g-4 mb-4">
                <div class="col-12">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-0">Cấu hình hệ thống</h5>
                                <small class="text-muted">KPIs, SLAs và các tham số vận hành</small>
                            </div>
                            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="collapse" data-bs-target="#configEditorCollapse">
                                <i class="bi bi-plus-lg me-1"></i>Tạo cấu hình
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <!-- Form tạo/cập nhật cấu hình (ẩn mặc định) -->
                            <div class="collapse" id="configEditorCollapse">
                                <div class="border-bottom p-3 bg-light">
                                    <form method="post" asp-page-handler="SaveConfig" id="configForm">
                                        <input asp-for="ConfigForm.ConfigId" type="hidden" />
                                        @if (Model.ActiveForm == nameof(Model.ConfigForm))
                                        {
                                            <div asp-validation-summary="All" class="text-danger small mb-2"></div>
                                        }
                                        <div class="row g-3">
                                            <div class="col-md-3">
                                                <label asp-for="ConfigForm.Name" class="form-label">Tên cấu hình</label>
                                                <input asp-for="ConfigForm.Name" class="form-control form-control-sm" placeholder="VD: MaxReservationsPerDay" />
                                                <span asp-validation-for="ConfigForm.Name" class="text-danger small"></span>
                                            </div>
                                            <div class="col-md-3">
                                                <label asp-for="ConfigForm.Value" class="form-label">Giá trị</label>
                                                <input asp-for="ConfigForm.Value" class="form-control form-control-sm" placeholder="VD: 100" />
                                                <span asp-validation-for="ConfigForm.Value" class="text-danger small"></span>
                                            </div>
                                            <div class="col-md-6">
                                                <label asp-for="ConfigForm.Description" class="form-label">Mô tả</label>
                                                <textarea asp-for="ConfigForm.Description" class="form-control form-control-sm" rows="1" placeholder="Mô tả ý nghĩa của cấu hình..."></textarea>
                                                <span asp-validation-for="ConfigForm.Description" class="text-danger small"></span>
                                            </div>
                                            <div class="col-12">
                                                <div class="d-flex gap-2">
                                                    <button type="submit" class="btn btn-primary btn-sm">
                                                        <i class="bi bi-save me-1"></i>Lưu
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary btn-sm" data-reset-target="configForm">
                                                        <i class="bi bi-arrow-counterclockwise me-1"></i>Mới
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#configEditorCollapse">
                                                        <i class="bi bi-x-lg me-1"></i>Đóng
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- Bảng danh sách cấu hình -->
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>#</th>
                                            <th>Tên cấu hình</th>
                                            <th>Giá trị</th>
                                            <th>Mô tả</th>
                                            <th class="text-end">Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var cfg in Model.Configs)
                                        {
                                            <tr>
                                                <td>@cfg.ConfigId</td>
                                                <td>
                                                    <span class="fw-semibold">@cfg.Name</span>
                                                </td>
                                                <td>
                                                    <span class="fw-semibold text-dark">@cfg.Value</span>
                                                </td>
                                                <td>
                                                    <div style="max-width: 400px;">
                                                        @(string.IsNullOrWhiteSpace(cfg.Description) ? "-" : cfg.Description)
                                                    </div>
                                                </td>
                                                <td class="text-end">
                                                    <div class="btn-group btn-group-sm">
                                                        <button type="button"
                                                                class="btn btn-outline-secondary config-edit-btn"
                                                                title="Chỉnh sửa"
                                                                data-payload='@Html.Raw(JsonSerializer.Serialize(new {
                                                                    ConfigId = cfg.ConfigId,
                                                                    cfg.Name,
                                                                    cfg.Value,
                                                                    cfg.Description
                                                                }))'>
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <form method="post" asp-page-handler="DeleteConfig" class="d-inline"
                                                              onsubmit="return confirm('Xóa cấu hình @cfg.Name?');">
                                                            <input type="hidden" name="configId" value="@cfg.ConfigId" />
                                                            <button class="btn btn-outline-danger" type="submit" title="Xóa">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </form>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                        @if (!Model.Configs.Any())
                                        {
                                            <tr>
                                                <td colspan="5" class="text-center text-muted py-4">Chưa có cấu hình nào.</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (() => {
            const collapseByForm = {
                batteryForm: 'batteryEditorCollapse',
                transferForm: 'transferEditorCollapse',
                staffForm: 'staffEditorCollapse',
                supportForm: 'supportEditorCollapse',
                configForm: 'configEditorCollapse'
            };

            const parsePayload = (btn) => {
                try { return JSON.parse(btn.dataset.payload); }
                catch { return null; }
            };

            const fillForm = (formId, prefix, payload) => {
                const form = document.getElementById(formId);
                if (!form || !payload) return;

                form.reset();
                Object.entries(payload).forEach(([key, value]) => {
                    const control = form.querySelector(`[name="${prefix}.${key}"]`);
                    if (!control) return;
                    control.value = value ?? '';
                    control.dispatchEvent(new Event('change'));
                });
            };

            const resetForm = (formId) => {
                const form = document.getElementById(formId);
                if (!form) return;

                form.reset();
                form.querySelectorAll('.field-validation-error').forEach(el => {
                    el.textContent = '';
                    el.classList.remove('field-validation-error');
                    el.classList.add('field-validation-valid');
                });

                const summary = form.querySelector('[data-valmsg-summary="true"]');
                if (summary) {
                    summary.classList.remove('validation-summary-errors');
                    summary.classList.add('validation-summary-valid');
                    const list = summary.querySelector('ul');
                    if (list) {
                        list.innerHTML = '';
                    }
                }

                form.querySelectorAll('input[type="hidden"]').forEach(input => {
                    if (input.name.includes('Id')) {
                        input.value = '0';
                    }
                });

                form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            };

            const showEditorPanel = (collapseId) => {
                const panel = document.getElementById(collapseId);
                if (!panel) return;
                const collapse = bootstrap.Collapse.getOrCreateInstance(panel, { toggle: false });
                collapse.show();
            };

            const wireEditor = (selector, formId, prefix, collapseId) => {
                document.querySelectorAll(selector).forEach(btn => {
                    btn.addEventListener('click', () => {
                        const payload = parsePayload(btn);
                        if (payload) {
                            fillForm(formId, prefix, payload);
                            if (collapseId) {
                                showEditorPanel(collapseId);
                            }
                        }
                    });
                });
            };

            document.querySelectorAll('[data-reset-target]').forEach(btn => {
                btn.addEventListener('click', () => {
                    resetForm(btn.dataset.resetTarget);
                });
            });

            wireEditor('.battery-edit-btn', 'batteryForm', 'BatteryForm', collapseByForm.batteryForm);
            wireEditor('.transfer-edit-btn', 'transferForm', 'TransferForm', collapseByForm.transferForm);
            wireEditor('.staff-edit-btn', 'staffForm', 'StationStaffForm', collapseByForm.staffForm);
            wireEditor('.support-edit-btn', 'supportForm', 'SupportForm', collapseByForm.supportForm);
            wireEditor('.config-edit-btn', 'configForm', 'ConfigForm', collapseByForm.configForm);

            document.querySelectorAll('.station-edit-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const stationId = btn.dataset.stationId;
                    if (!stationId) return;
                    const returnUrl = encodeURIComponent(window.location.pathname + window.location.search);
                    window.location.href = `/Admin/Operations/Stations/Edit/${stationId}?returnUrl=${returnUrl}`;
                });
            });

            const tabsKey = 'operations.activeTab';
            const tabButtons = document.querySelectorAll('#operationsTabs button[data-bs-toggle="tab"]');
            tabButtons.forEach(btn => {
                btn.addEventListener('shown.bs.tab', (event) => {
                    sessionStorage.setItem(tabsKey, event.target.id);
                });
            });

            const savedTabId = sessionStorage.getItem(tabsKey);
            if (savedTabId) {
                const trigger = document.getElementById(savedTabId);
                if (trigger) {
                    const tab = new bootstrap.Tab(trigger);
                    tab.show();
                }
            }

            const transferBatterySelect = document.getElementById('transfer-battery-select');
            const transferFromSelect = document.querySelector('[name="TransferForm.FromStationId"]');

            const syncFromStation = () => {
                if (!transferBatterySelect || !transferFromSelect) return;
                const selected = transferBatterySelect.selectedOptions[0];
                if (selected?.dataset.station) {
                    transferFromSelect.value = selected.dataset.station;
                }
            };

            if (transferBatterySelect) {
                transferBatterySelect.addEventListener('change', syncFromStation);
            }
            syncFromStation();

            const transferDateFilter = document.getElementById('transfer-date-filter');
            const transferStatusFilter = document.getElementById('transfer-status-filter');
            const transferFilterApply = document.getElementById('transfer-filter-apply');

            const filterTransferRows = () => {
                const rows = document.querySelectorAll('#transferScheduleTable tbody tr');
                const dateValue = transferDateFilter?.value;
                const statusValue = transferStatusFilter?.value;

                rows.forEach(row => {
                    const rowDate = row.dataset.transferTime
                        ? new Date(row.dataset.transferTime).toISOString().split('T')[0]
                        : '';
                    const rowStatus = row.dataset.transferStatus ?? '';
                    let isVisible = true;

                    if (dateValue && rowDate !== dateValue) {
                        isVisible = false;
                    }
                    if (statusValue && statusValue !== '' && rowStatus !== statusValue) {
                        isVisible = false;
                    }

                    row.style.display = isVisible ? '' : 'none';
                });
            };

            [transferDateFilter, transferStatusFilter].forEach(filter => {
                filter?.addEventListener('change', filterTransferRows);
            });
            transferFilterApply?.addEventListener('click', filterTransferRows);

            document.querySelectorAll('form[method="post"]').forEach(form => {
                form.addEventListener('submit', function (e) {
                    if (!form.checkValidity()) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                    form.classList.add('was-validated');
                });
            });

            setTimeout(() => {
                const alerts = document.querySelectorAll('.alert');
                alerts.forEach(alert => {
                    const bsAlert = bootstrap.Alert.getInstance(alert);
                    if (bsAlert) {
                        bsAlert.close();
                    }
                });
            }, 5000);
        })();
    </script>
}

